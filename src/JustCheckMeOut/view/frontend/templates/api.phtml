<?php
declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use PerspectiveTeam\JustCheckMeOut\Block\Stateful;
use PerspectiveTeam\JustCheckMeOut\ViewModel\HeadlessComponentRenderer;
use PerspectiveTeam\JustCheckMeOut\ViewModel\QuoteViewModel;
use PerspectiveTeam\SsrGraphql\ViewModel\SsrGraphqlViewModel;

/** @var Stateful $block */
/** @var Escaper $escaper */

$cartId = $block->quoteViewModel->getMaskedQuoteId();
$scriptTagId = uniqid('justcheckmeout-api-script_');
?>

<script id="<?= $scriptTagId ?>">
    window.justCheckMeOutApiV1 = {
        globals: {
            cartId: function () {
                return Alpine.store('justcheckmeout::cartId') ?? <?= "'$cartId'" ?>;
            },
            registerPlaceOrderGuard: function (slug, priority, handler) {
                const guards = Alpine.store('justcheckmeout::placeOrderGuards') ?? {};
                guards[slug] = {priority, handler};
                Alpine.store('justcheckmeout::placeOrderGuards', guards);
            },
            getPlaceOrderGuardHandlers: function () {
                const guards = Alpine.store('justcheckmeout::placeOrderGuards') ?? {};
                return Object.entries(guards)
                    .sort((a, b) => a[1].priority - b[1].priority)
                    .map(([slug, data]) => data.handler);
            },
            registerPlaceOrderHook: function (paymentMethodCode, handler) {
                const hooks = Alpine.store('justcheckmeout::placeOrderHooks') ?? {};
                hooks[paymentMethodCode] = handler;
                Alpine.store('justcheckmeout::placeOrderHooks', hooks);
            },
            getPlaceOrderHook: function (paymentMethodCode) {
                return (Alpine.store('justcheckmeout::placeOrderHooks') ?? {})[paymentMethodCode];
            },
        },
        bus: {
            on: function (event, callback) {
                const events = Alpine.store(`justcheckmeout::events::${event}`) ?? [];
                events.push(callback);
                Alpine.store(`justcheckmeout::events::${event}`, events);
            },
            fire: async function (event, payload) {
                const events = Alpine.store(`justcheckmeout::events::${event}`) ?? [];
                for (const callback of events) {
                    await callback(payload);
                }
            },
        },
        fn: {},
        component: {},
    };
</script>

<?= $block->getChildHtml('justcheckmeout.api.after') ?>
