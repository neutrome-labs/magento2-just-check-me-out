<?php
declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use PerspectiveTeam\JustCheckMeOut\ViewModel\QuoteViewModel;
use PerspectiveTeam\SsrGraphql\ViewModel\SsrGraphqlViewModel;

/** @var Template $block */
/** @var Escaper $escaper */

/** @var SsrGraphqlViewModel $gql */
$gql = $block->getData('ssrGqlViewModel');
/** @var QuoteViewModel $quoteViewModel */
$quoteViewModel = $block->getData('quoteViewModel');
?>

<script>
    window.justCheckMeOutApiV1.component.createPaymentMethodList = function (props = {
        refreshEvents: ['state.set.customer', 'state.set.shipping-address', 'state.set.shipping-method'],
    }) {
        <?php const PAYMENT_METHODS_LIST_GQL = <<<GRAPHQL
query paymentMethodsAvailable(\$cart_id: String!) {
  cart(cart_id: \$cart_id) {
    available_payment_methods {
      code
      title
    }
    selected_payment_method {
      code
      details_html
    }
  }
}
GRAPHQL;

        const SET_PAYMENT_METHOD_GQL = <<<GRAPHQL
mutation setPaymentMethod(\$card_id: String!, \$code: String!){
  setPaymentMethodOnCart(input: {
    cart_id: \$card_id,
    payment_method: {
      code: \$code
    }
  }){
    cart {
      available_payment_methods {
        code
        title
      }
      selected_payment_method {
        code
        details_html
      }
    }
  }
}
GRAPHQL;
        ?>

        return {
            methodsGql: <?= $gql->makeSsrGqlCall(PAYMENT_METHODS_LIST_GQL, [
                'cart_id' => $quoteViewModel->getMaskedQuoteId(),
            ]) ?>,

            interactive: true,
            methodsAvailable: [],
            selectedMethod: undefined,
            selectedMethodDetailsHtml: undefined,

            tryExtractGqlData: function (data) {
                this.methodsAvailable = data?.cart?.available_payment_methods;
                if (data?.cart?.selected_payment_method) {
                    const newMethodCode = data?.cart?.selected_payment_method?.code;
                    if (this.selectedMethod !== newMethodCode) {
                        this.selectedMethod = newMethodCode;
                        this.selectedMethodDetailsHtml = data?.cart?.selected_payment_method?.details_html;
                    }
                }
            },
            tryExtractGqlErrors: function (errors) {
                if (errors?.length > 0) {
                    for (const e of errors) {
                        this.$dispatch('justcheckmeout-message-payment-method-list', {
                            type: 'error',
                            text: e.message,
                        });
                    }
                }
            },

            init: function () {
                this.tryExtractGqlData(this.methodsGql?.data);
                this.tryExtractGqlErrors(this.methodsGql?.errors);

                for (const e of props.refreshEvents) {
                    window.justCheckMeOutApiV1.bus.on(e, async () => {
                        try {
                            this.interactive = false;

                            await this.methodsGql.refresh();
                            this.tryExtractGqlData(this.methodsGql?.data);
                            this.tryExtractGqlErrors(this.methodsGql?.errors);
                        } finally {
                            this.interactive = true;
                        }
                    });
                }
            },

            selectMethod: async function (method) {
                try {
                    this.interactive = false;

                    const r = await window.fetchMagento2Gql(`<?= SET_PAYMENT_METHOD_GQL ?>`, {
                        card_id: window.justCheckMeOutApiV1.globals.getCartId(),
                        code: method.code,
                    });
                    this.tryExtractGqlData(r.data?.setPaymentMethodOnCart);
                    this.tryExtractGqlErrors(r.errors);
                } finally {
                    this.interactive = true;
                }

                window.justCheckMeOutApiV1.bus.fire('state.set.payment-method', this.selectedMethod);
            }
        };
    }
</script>
