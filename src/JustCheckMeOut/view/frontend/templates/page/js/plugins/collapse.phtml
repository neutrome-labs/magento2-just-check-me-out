<?php
/**
 * Alpine.js Collapse Plugin for Hyva Theme
 * @see https://alpinejs.dev/plugins/collapse
 */

declare(strict_types=1);

use Magento\Framework\View\Element\Template;
use Magento\Framework\Escaper;

/** @var Template $block */
/** @var Escaper $escaper */
?>
<script>
    (() => {
        function src_default(Alpine) {
            Alpine.directive('collapse', Alpine.skipDuringClone((el, { modifiers }) => {
                let duration = modifierValue(modifiers, 'duration', 250) / 1000;
                let floor = modifierValue(modifiers, 'min', 0);
                let fullyHide = !modifiers.includes('min');

                if (!el._x_isShown) el.style.height = `${floor}px`;
                if (!el._x_isShown && fullyHide) el.hidden = true;
                if (!el._x_isShown) el.style.overflow = 'hidden';

                let setFunction = (el, styles) => {
                    let revertRecords = [];
                    Object.entries(styles).forEach(([key, value]) => {
                        revertRecords.push({
                            key,
                            value: el.style[key]
                        });
                        el.style[key] = value;
                    });
                    return () => {
                        revertRecords.forEach(({ key, value }) => {
                            el.style[key] = value;
                        });
                    };
                };

                let transitionStyles = {
                    transitionProperty: 'height',
                    transitionDuration: `${duration}s`,
                    transitionTimingFunction: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
                };

                el._x_transition = {
                    in(before = () => {}, after = () => {}) {
                        if (fullyHide) el.hidden = false;
                        if (fullyHide) el.style.display = null;
                        let current = el.getBoundingClientRect().height;
                        el.style.height = 'auto';
                        let full = el.getBoundingClientRect().height;
                        if (current === full) { current = floor; }
                        Alpine.transition(el, Alpine.setStyles, {
                            during: transitionStyles,
                            start: { height: current + 'px' },
                            end: { height: full + 'px' }
                        }, () => el._x_isShown = true, () => {
                            if (el.style.height === `${full}px`) {
                                el.style.overflow = null;
                            }
                        });
                    },
                    out(before = () => {}, after = () => {}) {
                        let full = el.getBoundingClientRect().height;
                        Alpine.transition(el, setFunction, {
                            during: transitionStyles,
                            start: { height: full + 'px' },
                            end: { height: floor + 'px' }
                        }, () => el.style.overflow = 'hidden', () => {
                            el._x_isShown = false;
                            if (el.style.height === `${floor}px` && fullyHide) {
                                el.style.display = 'none';
                                el.hidden = true;
                            }
                        });
                    }
                };
            }));
        }

        function modifierValue(modifiers, key, fallback) {
            if (modifiers.indexOf(key) === -1) return fallback;
            const rawValue = modifiers[modifiers.indexOf(key) + 1];
            if (!rawValue) return fallback;
            if (key === 'duration' || key === 'min') {
                let match = rawValue.match(/([0-9]+)ms/);
                if (match) return match[1];
            }
            return rawValue;
        }

        document.addEventListener('alpine:init', () => {
            window.Alpine.plugin(src_default);
        });
    })();
    //# sourceURL=alpine-collapse.js
</script>
